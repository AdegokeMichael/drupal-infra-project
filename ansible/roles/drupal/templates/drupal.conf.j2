<VirtualHost *:80>
    # Required for ALB health checks and proper domain handling
    ServerName {{ ansible_fqdn | default('localhost') }}
    ServerAdmin webmaster@localhost
    DocumentRoot "{{ drupal_project_dir }}/web"

    <Directory "{{ drupal_project_dir }}/web">
        Options FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.php
        
        # Security: Prevent directory listing
        Options -Indexes
        
        # Rewrite rules for clean URLs
        RewriteEngine on
        RewriteBase /
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]
    </Directory>

    # Handle PHP files
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php/php8.3-fpm.sock|fcgi://localhost"
    </FilesMatch>

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/drupal_error.log
    CustomLog ${APACHE_LOG_DIR}/drupal_access.log combined
    LogLevel warn

    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
</VirtualHost>
